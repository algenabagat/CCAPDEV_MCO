<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Reservations</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #b0c4a8;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .status-pill {
      padding: 5px 12px;
      border-radius: 20px;
      color: white;
      font-weight: bold;
      display: inline-block;
    }
    .status-confirmed { background-color: #28a745; }
    .status-pending { background-color: #ffc107; color: black; }
    .edit-btn, .delete-btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .edit-btn { background-color: #37aa46; color: white; }
    .delete-btn { background-color: #c53737; color: white; }
    #editModal {
      display: none;
      position: fixed;
      top: 15%;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      z-index: 1000;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">{{#if (eq currentUser.email user.email)}}My Reservations{{else}}Reservations{{/if}}</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Lab</th>
              <th>Date</th>
              <th>Time</th>
              <th>Seat No.</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {{#if reservations}}
              {{#each reservations}}
              <tr>
                <td>{{this.laboratory.name}}</td>
                <td>{{formatDate this.startTime 'YYYY-MM-DD'}}</td>
                <td>{{formatDate this.startTime 'HH:mm'}} - {{formatDate this.endTime 'HH:mm'}}</td>
                <td>{{this.seats.[0].seatNumber}}</td>
                <td>
                  {{#if (eq this.status 'Active')}}
                    <span class="badge bg-success">{{this.status}}</span>
                  {{else if (eq this.status 'Pending')}}
                    <span class="badge bg-warning text-dark">{{this.status}}</span>
                  {{else if (eq this.status 'Cancelled')}}
                    <span class="badge bg-danger">{{this.status}}</span>
                  {{else}}
                    <span class="badge bg-secondary">{{this.status}}</span>
                  {{/if}}
                </td>
                <td>
                  <button class="btn btn-sm btn-success me-1"
                    onclick="editReservation('{{this._id}}')"
                    data-id="{{this._id}}"
                    data-lab="{{this.laboratory.name}}"
                    data-seat="{{this.seats.[0].seatNumber}}"
                    data-date="{{formatDate this.startTime 'YYYY-MM-DD'}}"
                    data-start="{{formatDate this.startTime 'HH:mm'}}"
                    data-end="{{formatDate this.endTime 'HH:mm'}}"
                    data-status="{{this.status}}"
                  >Edit</button>

                  <form action="/reservations/delete/{{this._id}}" method="POST" style="display:inline;" onsubmit="return confirm('Delete this reservation?');">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                  </form>
                </td>
              </tr>
              {{/each}}
            {{else}}
              <tr>
                <td colspan="6" class="text-center text-muted">No reservations yet.</td>
              </tr>
            {{/if}}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" style="display:none; position:fixed; top:15%; left:50%; transform:translateX(-50%); width:320px; background:white; padding:20px; border-radius:8px; box-shadow:0 0 15px rgba(0,0,0,0.2); z-index:1000;">
  <h5>Edit Reservation</h5>
  <form id="editForm" method="POST">
    <div class="mb-2">
      <label class="form-label">Lab</label>
      <input name="lab" id="editLab" class="form-control" disabled />
    </div>
    <div class="mb-2">
      <label class="form-label">Seat</label>
      <input name="seat" id="editSeat" class="form-control" />
    </div>
    <div class="mb-2">
      <label class="form-label">Date</label>
      <input name="reservationDate" type="date" id="editDate" class="form-control" />
    </div>
    <div class="mb-2">
      <label class="form-label">Start Time</label>
      <input name="startTime" type="time" id="editStart" class="form-control" />
    </div>
    <div class="mb-2">
      <label class="form-label">End Time</label>
      <input name="endTime" type="time" id="editEnd" class="form-control" />
    </div>
    <div class="mb-3">
      <label class="form-label">Status</label>
      <select name="status" id="editStatus" class="form-control">
        <option value="Active">Active</option>
        <option value="Pending">Pending</option>
      </select>
    </div>
    <div class="text-end">
      <button type="submit" class="btn btn-primary">Save</button>
      <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    </div>
  </form>
</div>

<script>
  function editReservation(id) {
    const btn = document.querySelector(`button[onclick="editReservation('${id}')"]`);
    document.getElementById("editLab").value = btn.dataset.lab;
    document.getElementById("editSeat").value = btn.dataset.seat;
    document.getElementById("editDate").value = btn.dataset.date;
    document.getElementById("editStart").value = btn.dataset.start;
    document.getElementById("editEnd").value = btn.dataset.end;
    document.getElementById("editStatus").value = btn.dataset.status;

    document.getElementById("editForm").action = `/reservations/update/${id}`;
    document.getElementById("editModal").style.display = "block";
  }

  function closeModal() {
    document.getElementById("editModal").style.display = "none";
  }
</script>

</body>
</html>
